"""Area code to state mapping for call reporting"""

# Comprehensive mapping of area codes to US states
# Format: {area_code: state_name}
AREA_CODE_TO_STATE = {
    # Alabama
    "205": "Alabama", "251": "Alabama", "256": "Alabama", "334": "Alabama", "938": "Alabama",
    # Alaska
    "907": "Alaska",
    # Arizona
    "480": "Arizona", "520": "Arizona", "602": "Arizona", "623": "Arizona", "928": "Arizona",
    # Arkansas
    "479": "Arkansas", "501": "Arkansas", "870": "Arkansas",
    # California
    "209": "California", "213": "California", "310": "California", "323": "California",
    "408": "California", "415": "California", "424": "California", "442": "California",
    "510": "California", "530": "California", "559": "California", "562": "California",
    "619": "California", "626": "California", "628": "California", "650": "California",
    "657": "California", "661": "California", "669": "California", "707": "California",
    "714": "California", "747": "California", "760": "California", "805": "California",
    "818": "California", "831": "California", "858": "California", "909": "California",
    "916": "California", "925": "California", "949": "California", "951": "California",
    # Colorado
    "303": "Colorado", "719": "Colorado", "720": "Colorado", "970": "Colorado",
    # Connecticut
    "203": "Connecticut", "475": "Connecticut", "860": "Connecticut", "959": "Connecticut",
    # Delaware
    "302": "Delaware",
    # District of Columbia
    "202": "District of Columbia",
    # Florida
    "239": "Florida", "305": "Florida", "321": "Florida", "352": "Florida", "386": "Florida",
    "407": "Florida", "561": "Florida", "689": "Florida", "727": "Florida", "754": "Florida",
    "772": "Florida", "786": "Florida", "813": "Florida", "850": "Florida", "863": "Florida",
    "904": "Florida", "941": "Florida", "954": "Florida",
    # Georgia
    "229": "Georgia", "404": "Georgia", "470": "Georgia", "478": "Georgia", "678": "Georgia",
    "706": "Georgia", "762": "Georgia", "770": "Georgia", "912": "Georgia",
    # Hawaii
    "808": "Hawaii",
    # Idaho
    "208": "Idaho", "986": "Idaho",
    # Illinois
    "217": "Illinois", "224": "Illinois", "309": "Illinois", "312": "Illinois", "331": "Illinois",
    "618": "Illinois", "630": "Illinois", "708": "Illinois", "730": "Illinois", "773": "Illinois",
    "779": "Illinois", "815": "Illinois", "847": "Illinois", "872": "Illinois",
    # Indiana
    "219": "Indiana", "260": "Indiana", "317": "Indiana", "463": "Indiana", "574": "Indiana",
    "765": "Indiana", "812": "Indiana", "930": "Indiana",
    # Iowa
    "319": "Iowa", "515": "Iowa", "563": "Iowa", "641": "Iowa", "712": "Iowa",
    # Kansas
    "316": "Kansas", "620": "Kansas", "785": "Kansas", "913": "Kansas",
    # Kentucky
    "270": "Kentucky", "364": "Kentucky", "502": "Kentucky", "606": "Kentucky", "859": "Kentucky",
    # Louisiana
    "225": "Louisiana", "318": "Louisiana", "337": "Louisiana", "504": "Louisiana", "985": "Louisiana",
    # Maine
    "207": "Maine",
    # Maryland
    "240": "Maryland", "301": "Maryland", "410": "Maryland", "443": "Maryland", "667": "Maryland",
    # Massachusetts
    "339": "Massachusetts", "351": "Massachusetts", "413": "Massachusetts", "508": "Massachusetts",
    "617": "Massachusetts", "774": "Massachusetts", "781": "Massachusetts", "857": "Massachusetts", "978": "Massachusetts",
    # Michigan
    "231": "Michigan", "248": "Michigan", "269": "Michigan", "313": "Michigan", "517": "Michigan",
    "586": "Michigan", "616": "Michigan", "734": "Michigan", "810": "Michigan", "906": "Michigan",
    "947": "Michigan", "989": "Michigan",
    # Minnesota
    "218": "Minnesota", "320": "Minnesota", "507": "Minnesota", "612": "Minnesota", "651": "Minnesota",
    "763": "Minnesota", "952": "Minnesota",
    # Mississippi
    "228": "Mississippi", "601": "Mississippi", "662": "Mississippi", "769": "Mississippi",
    # Missouri
    "314": "Missouri", "417": "Missouri", "573": "Missouri", "636": "Missouri", "660": "Missouri",
    "816": "Missouri",
    # Montana
    "406": "Montana",
    # Nebraska
    "308": "Nebraska", "402": "Nebraska", "531": "Nebraska",
    # Nevada
    "702": "Nevada", "725": "Nevada", "775": "Nevada",
    # New Hampshire
    "603": "New Hampshire",
    # New Jersey
    "201": "New Jersey", "551": "New Jersey", "609": "New Jersey", "732": "New Jersey",
    "848": "New Jersey", "856": "New Jersey", "862": "New Jersey", "908": "New Jersey", "973": "New Jersey",
    # New Mexico
    "505": "New Mexico", "575": "New Mexico",
    # New York
    "212": "New York", "315": "New York", "332": "New York", "347": "New York", "516": "New York",
    "518": "New York", "585": "New York", "607": "New York", "631": "New York", "646": "New York",
    "680": "New York", "716": "New York", "718": "New York", "838": "New York", "845": "New York",
    "914": "New York", "917": "New York", "929": "New York", "934": "New York",
    # North Carolina
    "252": "North Carolina", "336": "North Carolina", "704": "North Carolina", "743": "North Carolina",
    "828": "North Carolina", "910": "North Carolina", "980": "North Carolina", "984": "North Carolina",
    # North Dakota
    "701": "North Dakota",
    # Ohio
    "216": "Ohio", "220": "Ohio", "234": "Ohio", "326": "Ohio", "330": "Ohio", "380": "Ohio",
    "419": "Ohio", "440": "Ohio", "513": "Ohio", "567": "Ohio", "614": "Ohio", "740": "Ohio",
    "937": "Ohio",
    # Oklahoma
    "405": "Oklahoma", "539": "Oklahoma", "572": "Oklahoma", "580": "Oklahoma", "918": "Oklahoma",
    # Oregon
    "458": "Oregon", "503": "Oregon", "541": "Oregon", "971": "Oregon",
    # Pennsylvania
    "215": "Pennsylvania", "223": "Pennsylvania", "267": "Pennsylvania", "272": "Pennsylvania",
    "412": "Pennsylvania", "445": "Pennsylvania", "484": "Pennsylvania", "570": "Pennsylvania",
    "610": "Pennsylvania", "717": "Pennsylvania", "724": "Pennsylvania", "814": "Pennsylvania", "878": "Pennsylvania",
    # Rhode Island
    "401": "Rhode Island",
    # South Carolina
    "803": "South Carolina", "839": "South Carolina", "843": "South Carolina", "854": "South Carolina", "864": "South Carolina",
    # South Dakota
    "605": "South Dakota",
    # Tennessee
    "423": "Tennessee", "615": "Tennessee", "629": "Tennessee", "731": "Tennessee", "865": "Tennessee", "901": "Tennessee", "931": "Tennessee",
    # Texas
    "210": "Texas", "214": "Texas", "254": "Texas", "281": "Texas", "325": "Texas", "346": "Texas",
    "361": "Texas", "409": "Texas", "430": "Texas", "432": "Texas", "469": "Texas", "512": "Texas",
    "713": "Texas", "726": "Texas", "737": "Texas", "806": "Texas", "817": "Texas", "830": "Texas",
    "832": "Texas", "903": "Texas", "915": "Texas", "936": "Texas", "940": "Texas", "945": "Texas",
    "956": "Texas", "972": "Texas", "979": "Texas",
    # Utah
    "385": "Utah", "435": "Utah", "801": "Utah",
    # Vermont
    "802": "Vermont",
    # Virginia
    "276": "Virginia", "434": "Virginia", "540": "Virginia", "571": "Virginia", "703": "Virginia",
    "757": "Virginia", "804": "Virginia",
    # Washington
    "206": "Washington", "253": "Washington", "360": "Washington", "425": "Washington", "509": "Washington", "564": "Washington",
    # West Virginia
    "304": "West Virginia", "681": "West Virginia",
    # Wisconsin
    "262": "Wisconsin", "414": "Wisconsin", "534": "Wisconsin", "608": "Wisconsin", "715": "Wisconsin", "920": "Wisconsin",
    # Wyoming
    "307": "Wyoming",
}

# Reverse mapping: state name to list of area codes
STATE_TO_AREA_CODES = {}
for area_code, state in AREA_CODE_TO_STATE.items():
    if state not in STATE_TO_AREA_CODES:
        STATE_TO_AREA_CODES[state] = []
    STATE_TO_AREA_CODES[state].append(area_code)

# Normalize state names (handle variations)
STATE_NORMALIZATION = {
    "nc": "North Carolina",
    "north carolina": "North Carolina",
    "sc": "South Carolina",
    "south carolina": "South Carolina",
    "ny": "New York",
    "new york": "New York",
    "ca": "California",
    "california": "California",
    "tx": "Texas",
    "texas": "Texas",
    "fl": "Florida",
    "florida": "Florida",
    "il": "Illinois",
    "illinois": "Illinois",
    "pa": "Pennsylvania",
    "pennsylvania": "Pennsylvania",
    "oh": "Ohio",
    "ohio": "Ohio",
    "ga": "Georgia",
    "georgia": "Georgia",
    "mi": "Michigan",
    "michigan": "Michigan",
    "nj": "New Jersey",
    "new jersey": "New Jersey",
    "va": "Virginia",
    "virginia": "Virginia",
    "wa": "Washington",
    "washington": "Washington",
    "az": "Arizona",
    "arizona": "Arizona",
    "ma": "Massachusetts",
    "massachusetts": "Massachusetts",
    "tn": "Tennessee",
    "tennessee": "Tennessee",
    "in": "Indiana",
    "indiana": "Indiana",
    "mo": "Missouri",
    "missouri": "Missouri",
    "md": "Maryland",
    "maryland": "Maryland",
    "wi": "Wisconsin",
    "wisconsin": "Wisconsin",
    "co": "Colorado",
    "colorado": "Colorado",
    "mn": "Minnesota",
    "minnesota": "Minnesota",
    "sc": "South Carolina",
    "south carolina": "South Carolina",
    "al": "Alabama",
    "alabama": "Alabama",
    "la": "Louisiana",
    "louisiana": "Louisiana",
    "ky": "Kentucky",
    "kentucky": "Kentucky",
    "or": "Oregon",
    "oregon": "Oregon",
    "ok": "Oklahoma",
    "oklahoma": "Oklahoma",
    "ct": "Connecticut",
    "connecticut": "Connecticut",
    "ut": "Utah",
    "utah": "Utah",
    "ia": "Iowa",
    "iowa": "Iowa",
    "nv": "Nevada",
    "nevada": "Nevada",
    "ar": "Arkansas",
    "arkansas": "Arkansas",
    "ms": "Mississippi",
    "mississippi": "Mississippi",
    "ks": "Kansas",
    "kansas": "Kansas",
    "nm": "New Mexico",
    "new mexico": "New Mexico",
    "ne": "Nebraska",
    "nebraska": "Nebraska",
    "wv": "West Virginia",
    "west virginia": "West Virginia",
    "id": "Idaho",
    "idaho": "Idaho",
    "hi": "Hawaii",
    "hawaii": "Hawaii",
    "nh": "New Hampshire",
    "new hampshire": "New Hampshire",
    "me": "Maine",
    "maine": "Maine",
    "mt": "Montana",
    "montana": "Montana",
    "ri": "Rhode Island",
    "rhode island": "Rhode Island",
    "de": "Delaware",
    "delaware": "Delaware",
    "sd": "South Dakota",
    "south dakota": "South Dakota",
    "nd": "North Dakota",
    "north dakota": "North Dakota",
    "ak": "Alaska",
    "alaska": "Alaska",
    "dc": "District of Columbia",
    "district of columbia": "District of Columbia",
    "vt": "Vermont",
    "vermont": "Vermont",
    "wy": "Wyoming",
    "wyoming": "Wyoming",
}


def normalize_state_name(state_input: str) -> str:
    """Normalize state name input to standard format"""
    state_lower = state_input.lower().strip()
    
    # Check normalization map first
    if state_lower in STATE_NORMALIZATION:
        return STATE_NORMALIZATION[state_lower]
    
    # Check if it's already a valid state name
    if state_input in STATE_TO_AREA_CODES:
        return state_input
    
    # Try title case
    state_title = state_input.title()
    if state_title in STATE_TO_AREA_CODES:
        return state_title
    
    return None


def get_area_codes_for_state(state: str) -> list[str]:
    """Get list of area codes for a given state"""
    normalized_state = normalize_state_name(state)
    if not normalized_state:
        return []
    return STATE_TO_AREA_CODES.get(normalized_state, [])


def extract_area_code(phone_number: str) -> str:
    """Extract area code from a phone number string (handles E.164 format)"""
    if not phone_number:
        return None
    
    # Convert to string and remove whitespace
    cleaned = str(phone_number).strip()
    
    if not cleaned:
        return None
    
    # Handle E.164 format: +1XXXXXXXXXX or +1-XXX-XXX-XXXX
    # Remove common formatting characters
    cleaned = cleaned.replace("-", "").replace("(", "").replace(")", "").replace(".", "").replace(" ", "").strip()
    
    # Handle E.164 format with +1 prefix
    if cleaned.startswith("+1"):
        cleaned = cleaned[2:]  # Remove "+1"
    elif cleaned.startswith("1") and len(cleaned) == 11:
        # US number starting with 1 (country code without +)
        cleaned = cleaned[1:]
    elif cleaned.startswith("+"):
        # International format, try to extract US number
        # E.164 for US: +1 followed by 10 digits
        if cleaned.startswith("+1") and len(cleaned) >= 12:
            cleaned = cleaned[2:]
        else:
            # Not a US number format
            return None
    
    # At this point, cleaned should be 10 digits for US numbers
    # Extract first 3 digits as area code
    if len(cleaned) >= 3 and cleaned[:3].isdigit():
        return cleaned[:3]
    
    return None


def is_number_from_state(phone_number: str, state: str) -> bool:
    """Check if a phone number belongs to a given state"""
    area_code = extract_area_code(phone_number)
    if not area_code:
        return False
    
    normalized_state = normalize_state_name(state)
    if not normalized_state:
        return False
    
    return area_code in STATE_TO_AREA_CODES.get(normalized_state, [])

